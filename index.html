<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stem Mixer ‚Äî Batterista Online</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0b0d0e; color: #e8e8e8;
  font-family: 'DM Sans', 'Helvetica Neue', sans-serif;
  min-height: 100vh; padding: 32px 16px 64px;
}
.app { max-width: 980px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

/* Header */
.header { display:flex; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; gap:12px; }
.header h1 { font-size:2rem; font-weight:700; letter-spacing:-0.02em; line-height:1; }
.header h1 span { color:#5dda9d; }
.header-sub { font-size:10px; text-transform:uppercase; letter-spacing:0.3em; color:#555; margin-top:6px; }
.header-right a { color:#444; text-decoration:none; font-size:11px; transition:color .2s; }
.header-right a:hover { color:#5dda9d; }

/* Cards */
.card { background:rgba(255,255,255,0.025); border:1px solid rgba(255,255,255,0.07); border-radius:20px; padding:24px; }
.card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
.card-label { font-size:10px; text-transform:uppercase; letter-spacing:0.35em; color:#555; }

/* Setup card ‚Äî shown when SPACE_ID is not configured */
.setup-card { background:rgba(93,218,157,0.04); border:1px solid rgba(93,218,157,0.15); border-radius:20px; padding:28px; }
.setup-title { font-size:1rem; font-weight:600; margin-bottom:8px; }
.setup-desc { font-size:13px; color:#888; line-height:1.75; margin-bottom:20px; }
.setup-desc a { color:#5dda9d; text-decoration:none; }
.setup-desc a:hover { text-decoration:underline; }
.setup-desc code { background:rgba(255,255,255,0.06); padding:2px 7px; border-radius:5px; font-family:'DM Mono',monospace; font-size:12px; color:#e8e8e8; }
.input-row { display:flex; gap:10px; flex-wrap:wrap; }
.space-input { flex:1; min-width:200px; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:12px 16px; color:#e8e8e8; font-family:'DM Mono',monospace; font-size:13px; outline:none; transition:border-color .2s; }
.space-input:focus { border-color:#5dda9d; }
.space-input::placeholder { color:#3a3a3a; }
.btn-primary { background:linear-gradient(135deg,#3a9d7a,#2a7c5f); border:none; border-radius:12px; padding:12px 22px; color:#fff; font-weight:600; font-size:13px; cursor:pointer; white-space:nowrap; font-family:'DM Sans',sans-serif; box-shadow:0 0 16px rgba(93,218,157,0.2); transition:all .2s; }
.btn-primary:hover { box-shadow:0 0 24px rgba(93,218,157,0.4); transform:translateY(-1px); }

/* Upload */
.upload-zone { border:2px dashed rgba(93,218,157,0.2); border-radius:16px; padding:52px 24px; text-align:center; cursor:pointer; transition:all .25s; position:relative; overflow:hidden; background:rgba(93,218,157,0.02); }
.upload-zone:hover, .upload-zone.over { border-color:rgba(93,218,157,0.55); background:rgba(93,218,157,0.06); }
.upload-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
.upload-icon { font-size:2.8rem; margin-bottom:14px; }
.upload-title { font-size:1.05rem; font-weight:600; margin-bottom:6px; }
.upload-sub { font-size:12px; color:#555; }
.upload-fmt { font-size:11px; color:#3a3a3a; margin-top:8px; }

/* Status */
.status-inner { display:flex; flex-direction:column; gap:16px; }
.status-top { display:flex; align-items:center; gap:14px; }
.spinner { width:36px; height:36px; border-radius:50%; border:3px solid rgba(93,218,157,0.12); border-top-color:#5dda9d; animation:spin .85s linear infinite; flex-shrink:0; }
@keyframes spin { to{transform:rotate(360deg)} }
.s-title { font-size:1rem; font-weight:600; }
.s-sub   { font-size:12px; color:#666; margin-top:3px; }
.prog-track { height:4px; background:rgba(255,255,255,0.06); border-radius:99px; overflow:hidden; }
.prog-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,#3a9d7a,#5dda9d); width:0%; transition:width .5s ease; box-shadow:0 0 8px rgba(93,218,157,0.4); }
.prog-fill.slide { width:35%; animation:slide 1.3s ease-in-out infinite; }
@keyframes slide { 0%{transform:translateX(-250%)} 100%{transform:translateX(400%)} }
.steps { display:flex; gap:7px; flex-wrap:wrap; }
.pill { font-size:10px; padding:4px 10px; border-radius:99px; border:1px solid rgba(255,255,255,0.07); color:#444; background:rgba(255,255,255,0.02); transition:all .3s; }
.pill.on   { border-color:rgba(93,218,157,0.4); color:#5dda9d; background:rgba(93,218,157,0.08); }
.pill.done { border-color:rgba(93,218,157,0.2); color:#3a9d7a; }
.pill.done::before { content:"‚úì "; }

/* Error */
.err-card { background:rgba(239,68,68,0.05); border:1px solid rgba(239,68,68,0.18); border-radius:20px; padding:24px; display:none; }
.err-title { font-weight:600; color:#f87171; margin-bottom:6px; }
.err-msg { font-size:13px; color:#777; line-height:1.65; white-space:pre-wrap; }
.btn-retry { margin-top:14px; background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.25); color:#f87171; border-radius:10px; padding:9px 18px; font-size:12px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all .2s; }
.btn-retry:hover { background:rgba(239,68,68,0.22); }

/* Transport */
#waveform-wrap { background:rgba(0,0,0,0.35); border-radius:12px; padding:14px 16px; cursor:pointer; margin-bottom:14px; }
#waveform-canvas { width:100%; height:64px; display:block; }
.transport-row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.time-now { font-family:'DM Mono',monospace; font-size:1.6rem; font-weight:500; color:#5dda9d; min-width:84px; }
.time-dur { font-family:'DM Mono',monospace; font-size:13px; color:#3a3a3a; }
.tbns { margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.btn-play-main { width:52px; height:52px; border-radius:15px; border:none; background:linear-gradient(135deg,#3a9d7a,#2a7c5f); color:#fff; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 0 20px rgba(93,218,157,0.25); transition:all .2s; }
.btn-play-main:hover { transform:scale(1.05); box-shadow:0 0 28px rgba(93,218,157,0.4); }
.btn-ic  { width:42px; height:42px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:#ccc; cursor:pointer; font-size:15px; display:flex; align-items:center; justify-content:center; transition:background .2s; }
.btn-ic:hover { background:rgba(255,255,255,0.1); }
.btn-txt { height:42px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:#aaa; cursor:pointer; padding:0 14px; font-size:11px; font-weight:600; display:flex; align-items:center; gap:6px; transition:background .2s; font-family:'DM Sans',sans-serif; white-space:nowrap; }
.btn-txt:hover { background:rgba(255,255,255,0.1); }
.btn-grn { height:42px; border-radius:12px; border:1px solid rgba(93,218,157,0.22); background:rgba(93,218,157,0.07); color:#5dda9d; cursor:pointer; padding:0 14px; font-size:11px; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .2s; font-family:'DM Sans',sans-serif; white-space:nowrap; }
.btn-grn:hover { background:rgba(93,218,157,0.14); }
.master-row { display:flex; align-items:center; gap:12px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.06); margin-top:16px; }
.master-lbl { font-size:10px; text-transform:uppercase; letter-spacing:.3em; color:#444; width:50px; }
.btn-mut { width:30px; height:30px; border-radius:9px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); cursor:pointer; font-size:13px; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all .2s; }
.btn-mut.on { background:#f97316; border-color:#f97316; }
input[type=range] { -webkit-appearance:none; appearance:none; background:transparent; cursor:pointer; flex:1; }
input[type=range]::-webkit-slider-track { height:4px; border-radius:99px; background:rgba(255,255,255,0.08); }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:#5dda9d; margin-top:-6px; box-shadow:0 0 8px rgba(93,218,157,0.4); }
.rv { font-family:'DM Mono',monospace; font-size:11px; color:#666; width:38px; text-align:right; }

/* Channels */
.ch-scroll { display:flex; gap:10px; overflow-x:auto; padding-bottom:8px; }
.ch-scroll::-webkit-scrollbar { height:3px; }
.ch-scroll::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.1); border-radius:2px; }
.ch { flex-shrink:0; width:106px; border-radius:18px; border:1px solid rgba(255,255,255,0.07); background:rgba(255,255,255,0.025); padding:14px 10px 16px; display:flex; flex-direction:column; align-items:center; gap:10px; transition:box-shadow .3s,border-color .3s; }
.ch-emoji { font-size:22px; line-height:1; }
.ch-name  { font-size:10px; text-transform:uppercase; letter-spacing:.2em; font-weight:700; }
.vu-wrap  { display:flex; gap:3px; }
.vu-strip { width:5px; height:44px; border-radius:99px; background:rgba(255,255,255,0.05); overflow:hidden; position:relative; }
.vu-fill  { position:absolute; bottom:0; left:0; right:0; border-radius:99px; transition:height .06s; }
.ch-db { font-family:'DM Mono',monospace; font-size:9px; color:#555; }
.fader-track { width:6px; height:164px; border-radius:99px; background:rgba(255,255,255,0.06); position:relative; cursor:pointer; touch-action:none; user-select:none; }
.fader-fill  { position:absolute; bottom:0; left:0; right:0; border-radius:99px; transition:height .06s; }
.fader-unity { position:absolute; left:-5px; right:-5px; height:1px; background:rgba(255,255,255,0.17); pointer-events:none; }
.fader-thumb { position:absolute; left:50%; transform:translateX(-50%); width:22px; height:22px; border-radius:6px; cursor:grab; border:1px solid; transition:box-shadow .2s; }
.fader-thumb:active { cursor:grabbing; }
.ch-pct { font-size:12px; font-weight:700; font-family:'DM Mono',monospace; }
.sm-row { display:flex; gap:5px; }
.btn-sm { width:30px; height:26px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:#666; cursor:pointer; font-size:10px; font-weight:700; font-family:'DM Sans',sans-serif; transition:all .15s; }

/* Solo banner */
.solo-ban { display:none; align-items:center; gap:8px; font-size:11px; color:#fbbf24; font-weight:600; background:rgba(251,191,36,0.08); border:1px solid rgba(251,191,36,0.2); border-radius:10px; padding:5px 14px; }
.solo-ban button { background:none; border:none; color:#fbbf24; cursor:pointer; opacity:.6; font-size:15px; line-height:1; padding:0; }
.solo-ban button:hover { opacity:1; }

/* Collapse */
.collapse-btn { width:26px; height:26px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:#888; cursor:pointer; font-size:11px; display:flex; align-items:center; justify-content:center; transition:background .2s; }
.collapse-btn:hover { background:rgba(255,255,255,0.1); }
.collapsible { overflow:hidden; transition:max-height .35s ease,opacity .3s ease; }
.collapsible.collapsed { max-height:0 !important; opacity:0; pointer-events:none; }

/* Overview */
.ov { display:flex; flex-direction:column; gap:8px; }
.ov-row { display:flex; align-items:center; gap:12px; }
.ov-name { font-size:13px; width:68px; flex-shrink:0; }
.ov-track { flex:1; height:6px; border-radius:99px; background:rgba(255,255,255,0.06); overflow:hidden; }
.ov-bar { height:100%; border-radius:99px; opacity:.75; transition:width .2s; }
.ov-val { font-family:'DM Mono',monospace; font-size:11px; color:#555; width:38px; text-align:right; }
.badges { display:flex; gap:4px; }
.badge { font-size:9px; font-weight:700; padding:2px 6px; border-radius:4px; }

/* Tip */
.tip { font-size:11px; color:#3a3a3a; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05); border-radius:10px; padding:10px 14px; line-height:1.6; margin-top:14px; }
.tip b { color:#666; }

/* Footer */
footer { border-top:1px solid rgba(255,255,255,0.07); padding-top:32px; text-align:center; margin-top:12px; }
footer p { font-size:11px; text-transform:uppercase; letter-spacing:.3em; color:#2a2a2a; margin-bottom:6px; }
.flinks { display:flex; align-items:center; justify-content:center; gap:16px; font-size:11px; margin-bottom:4px; }
.flinks a { color:#2a2a2a; text-decoration:none; transition:color .2s; }
.flinks a:hover { color:#5dda9d; }
.ver { font-size:11px; color:#222; margin-bottom:20px; }
.coffee { display:inline-flex; align-items:center; gap:8px; border-radius:99px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.03); padding:12px 24px; font-size:13px; font-weight:600; color:#555; text-decoration:none; transition:all .2s; }
.coffee:hover { border-color:#5dda9d; color:#5dda9d; }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div>
      <h1>Stem <span>Mixer</span></h1>
      <div class="header-sub">AI Stem Separator ¬∑ Powered by Demucs</div>
    </div>
    <div class="header-right">
      <a href="https://batterista.online" target="_blank">batterista.online</a>
    </div>
  </div>

  <!-- Setup (visibile solo se SPACE_ID non √® configurato) -->
  <div class="setup-card" id="setup-card" style="display:none;">
    <div class="setup-title">‚öôÔ∏è Configura il tuo Hugging Face Space</div>
    <div class="setup-desc">
      Crea il tuo Space gratuito su Hugging Face seguendo la guida inclusa nel pacchetto.<br>
      Una volta creato, inserisci il tuo Space ID (es. <code>tuonome/stem-mixer</code>):
    </div>
    <div class="input-row">
      <input class="space-input" type="text" id="space-input" placeholder="tuonome/stem-mixer" />
      <button class="btn-primary" id="btn-save-space">Salva ‚Üí</button>
    </div>
  </div>

  <!-- Upload -->
  <div class="card" id="upload-card">
    <div class="card-header">
      <span class="card-label">Carica la tua canzone</span>
      <button class="btn-txt" id="btn-change-space" style="height:28px;font-size:10px;padding:0 10px;display:none;">‚öôÔ∏è Cambia Space</button>
    </div>
    <div class="upload-zone" id="upload-zone">
      <input type="file" id="file-input" accept=".mp3,.wav,.flac,.ogg,.m4a,audio/*" />
      <div class="upload-icon">üéµ</div>
      <div class="upload-title">Trascina il tuo MP3 qui</div>
      <div class="upload-sub">oppure clicca per selezionare il file</div>
      <div class="upload-fmt">MP3 ¬∑ WAV ¬∑ FLAC ¬∑ OGG ¬∑ M4A</div>
    </div>
    <div class="tip">
      ‚è± La separazione AI richiede circa <b>1‚Äì3 minuti</b>.<br>
      Risultato: <b>Drums ¬∑ Bass ¬∑ Vocals ¬∑ Other</b> ‚Äî pronti sui fader.
    </div>
  </div>

  <!-- Status -->
  <div class="card" id="status-card" style="display:none;">
    <div class="status-inner">
      <div class="status-top">
        <div class="spinner"></div>
        <div>
          <div class="s-title" id="s-title">Avvio separazione‚Ä¶</div>
          <div class="s-sub"   id="s-sub">Connessione allo Space</div>
        </div>
      </div>
      <div class="prog-track"><div class="prog-fill slide" id="prog"></div></div>
      <div class="steps">
        <div class="pill" id="p-connect">üîå Connessione</div>
        <div class="pill" id="p-upload">üì§ Upload</div>
        <div class="pill" id="p-ai">‚öôÔ∏è Separazione AI</div>
        <div class="pill" id="p-dec">üîä Decodifica</div>
      </div>
      <div id="s-file" style="font-size:12px;color:#444;margin-top:4px;"></div>
    </div>
  </div>

  <!-- Error -->
  <div class="err-card" id="err-card">
    <div class="err-title">‚ö†Ô∏è Errore</div>
    <div class="err-msg" id="err-msg"></div>
    <button class="btn-retry" id="btn-retry">‚Ü© Riprova</button>
  </div>

  <!-- Mixer Transport -->
  <div class="card" id="mixer-card" style="display:none;">
    <div class="card-header">
      <span class="card-label">Transport</span>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="solo-ban" id="solo-ban">SOLO ATTIVO <button id="clear-solo">‚úï</button></div>
        <button class="collapse-btn" id="col-btn">‚ñ≤</button>
      </div>
    </div>
    <div class="collapsible" id="mixer-body" style="max-height:500px;">
      <div id="waveform-wrap"><canvas id="waveform-canvas" width="900" height="64"></canvas></div>
      <div id="track-name" style="font-size:12px;color:#444;margin-bottom:14px;"></div>
      <div class="transport-row">
        <span class="time-now" id="tnow">0:00</span>
        <span class="time-dur" id="tdur">/ 0:00</span>
        <div class="tbns">
          <button class="btn-play-main" id="btn-play">‚ñ∂</button>
          <button class="btn-ic"  id="btn-stop"  title="Stop">‚ñ†</button>
          <button class="btn-txt" id="btn-reset">‚Ü∫ Reset fader</button>
          <button class="btn-grn" id="btn-new">+ Nuova canzone</button>
        </div>
      </div>
      <div class="master-row">
        <span class="master-lbl">Master</span>
        <button class="btn-mut" id="btn-mmut">üîä</button>
        <input type="range" id="master-r" min="0" max="150" value="100" />
        <span class="rv" id="master-v">100%</span>
      </div>
    </div>
  </div>

  <!-- Channels -->
  <div class="card" id="ch-card" style="display:none;">
    <div class="card-header"><span class="card-label">Stem Channels</span></div>
    <div class="ch-scroll" id="ch-wrap"></div>
  </div>

  <!-- Overview -->
  <div class="card" id="ov-card" style="display:none;">
    <div class="card-header"><span class="card-label">Overview</span></div>
    <div class="ov" id="ov-rows"></div>
  </div>

  <footer>
    <p>Copyright ¬© Batterista Online ‚Äî Tutti i diritti riservati</p>
    <div class="flinks">
      <a href="https://batterista.online" target="_blank">www.batterista.online</a>
      <span style="color:#252525">‚Ä¢</span>
      <a href="/cdn-cgi/l/email-protection#70191e161f30121104041502190304115e1f1e1c191e15"><span class="__cf_email__" data-cfemail="aec7c0c8c1eecccfdadacbdcc7dddacf80c1c0c2c7c0cb">[email&#160;protected]</span></a>
    </div>
    <div class="ver">Stem Mixer v1.0 ¬∑ Powered by Demucs (Meta AI) via Hugging Face</div>
    <a href="https://www.buymeacoffee.com/batterista" target="_blank" class="coffee">
      Aiutami a mantenere questa app gratuita: ‚òï Offrimi un caff√®
    </a>
  </footer>

</div><!-- /app -->

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="module">

// ‚îÄ‚îÄ‚îÄ ‚öôÔ∏è CONFIGURA QUI IL TUO SPACE ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Dopo aver creato lo Space su Hugging Face, metti qui il tuo Space ID
// Formato: "tuonomeutente/nome-space"  es: "mario/stem-mixer"
// Se lo lasci vuoto, l'app chiede all'utente di inserirlo (non utile in produzione)
const HARDCODED_SPACE_ID = "GeenoPizza/abcdstem"; // ‚Üê METTI QUI IL TUO SPACE ID

// ‚îÄ‚îÄ‚îÄ Stem configs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STEM_CFGS = [
  { id:"drums",  label:"Drums",  emoji:"ü•Å", color:"#f97316", glow:"rgba(249,115,22,0.35)" },
  { id:"bass",   label:"Bass",   emoji:"üé∏", color:"#a855f7", glow:"rgba(168,85,247,0.35)" },
  { id:"vocals", label:"Vocals", emoji:"üé§", color:"#5dda9d", glow:"rgba(93,218,157,0.35)" },
  { id:"other",  label:"Other",  emoji:"‚ú®", color:"#ec4899", glow:"rgba(236,72,153,0.35)" },
];

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let spaceId = HARDCODED_SPACE_ID || localStorage.getItem("hf_space_id") || "";
let stems = STEM_CFGS.map(c => ({ id:c.id, volume:100, muted:false, solo:false, buffer:null, waveform:[], vuLevel:0 }));
let masterVol=100, masterMuted=false;
let isPlaying=false, curTime=0, totalDur=0, trackName="";
let transCollapsed=false;
let audioCtx=null, masterGain=null;
let stemNodes=[], startAt=0, pauseOff=0, animId=null, vuTimer=null;

// ‚îÄ‚îÄ‚îÄ Audio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);
  }
  return audioCtx;
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt = s => { if(!s||isNaN(s))return"0:00"; return`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,"0")}`; };
const hasSolo  = () => stems.some(s => s.solo);
const effMuted = s  => s.muted || (hasSolo() && !s.solo);
const effGain  = s  => (effMuted(s) || masterMuted) ? 0 : (s.volume/100) * (masterVol/100);
const $        = id => document.getElementById(id);

function show(id, v=true) {
  const el = $(id);
  if (el) el.style.display = v ? "block" : "none";
}

// ‚îÄ‚îÄ‚îÄ Space ID setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initUI() {
  if (spaceId) {
    show("setup-card", false);
    show("upload-card", true);
    if (!HARDCODED_SPACE_ID) $("btn-change-space").style.display = "flex";
  } else {
    show("setup-card", true);
    show("upload-card", false);
  }
}

$("btn-save-space").onclick = () => {
  const v = $("space-input").value.trim();
  if (!v.includes("/")) { alert('Formato non valido. Usa: tuonome/nome-space'); return; }
  spaceId = v;
  localStorage.setItem("hf_space_id", spaceId);
  show("setup-card", false);
  show("upload-card", true);
  $("btn-change-space").style.display = "flex";
};
$("space-input").onkeydown = e => { if(e.key==="Enter") $("btn-save-space").click(); };
$("btn-change-space").onclick = () => {
  show("upload-card", false);
  show("setup-card", true);
  $("space-input").value = spaceId;
};

// ‚îÄ‚îÄ‚îÄ Upload / drag-drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const zone = $("upload-zone"), fi = $("file-input");
zone.addEventListener("dragover",  e => { e.preventDefault(); zone.classList.add("over"); });
zone.addEventListener("dragleave", () => zone.classList.remove("over"));
zone.addEventListener("drop", e => {
  e.preventDefault(); zone.classList.remove("over");
  const f = e.dataTransfer.files[0]; if(f) go(f);
});
fi.addEventListener("change", e => { if(e.target.files[0]) go(e.target.files[0]); });

// ‚îÄ‚îÄ‚îÄ Status helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSt(title, sub, slide=false, pct=0) {
  $("s-title").textContent = title;
  $("s-sub").textContent   = sub || "";
  const p = $("prog");
  if (slide) { p.classList.add("slide"); p.style.width = "35%"; }
  else        { p.classList.remove("slide"); p.style.width = pct + "%"; }
}
function pill(id, state) {
  const e = $(id); if(!e) return;
  e.classList.remove("on","done");
  if(state) e.classList.add(state);
}

// ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function go(file) {
  trackName = file.name.replace(/\.[^.]+$/, "");
  show("upload-card", false); show("err-card", false); show("status-card", true);
  $("s-file").textContent = "üéµ " + file.name;
  setSt("Connessione allo Space‚Ä¶", spaceId, true);
  pill("p-connect","on"); pill("p-upload",""); pill("p-ai",""); pill("p-dec","");

  try {
    const bufs = await separateStems(file);
    buildMixer(bufs);
  } catch(err) {
    show("status-card", false); show("err-card", true);
    $("err-msg").textContent = err.message || String(err);
    console.error(err);
  }
}

async function separateStems(file) {
  const ctx = getCtx();
  const spaceUrl = `https://${spaceId.replace("/", "-")}.hf.space`;

  // 1. Upload file
  pill("p-connect","done"); pill("p-upload","on");
  setSt("Upload del brano‚Ä¶", "Invio a Hugging Face", true);

  const formData = new FormData();
  formData.append("files", file);

  let uploadedPath;
  try {
    const r = await fetch(`${spaceUrl}/upload`, { method:"POST", body: formData });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const json = await r.json();
    uploadedPath = Array.isArray(json) ? json[0] : json;
  } catch(e) {
    throw new Error(
      `Impossibile raggiungere lo Space.\n` +
      `‚Ä¢ Verifica che sia online: huggingface.co/spaces/${spaceId}\n` +
      `‚Ä¢ Se √® in sleep clicca "Restart" su HF e riprova tra 30 secondi\n\n` +
      `Dettaglio: ${e.message}`
    );
  }

  pill("p-upload","done"); pill("p-ai","on");
  setSt("Separazione AI in corso‚Ä¶", "Demucs sta analizzando il brano (1-3 min)", true);

  // 2. Predict
  let predictData;
  try {
    const r = await fetch(`${spaceUrl}/run/predict`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fn_index: 0,
        data: [{ name: uploadedPath, data: null, is_file: true }],
        session_hash: Math.random().toString(36).slice(2)
      })
    });
    if (!r.ok) throw new Error(`HTTP ${r.status} ‚Äî ${await r.text().then(t=>t.slice(0,200))}`);
    predictData = await r.json();
  } catch(e) {
    throw new Error(`Errore durante la separazione AI.\n\nDettaglio: ${e.message}`);
  }

  pill("p-ai","done"); pill("p-dec","on");
  setSt("Decodifica audio‚Ä¶", "Preparazione dei canali", false, 80);

  const outputs = predictData?.data;
console.log("RISPOSTA SPACE:", JSON.stringify(predictData).slice(0, 500));
if (!outputs?.length) throw new Error("Il modello non ha restituito audio. Riprova.");

  const stemOrder = ["drums","bass","vocals","other"];
  const bufMap = {};

  for (let i = 0; i < outputs.length; i++) {
    const out    = outputs[i];
    const stemId = stemOrder[i] || `stem_${i}`;
    setSt(`Decodifica ${stemId}‚Ä¶`, "", false, 80 + i * 5);

    let url = null;
    if      (typeof out === "string")           url = out;
    else if (out?.url)                          url = out.url;
    else if (out?.data?.startsWith("data:"))    { /* base64 inline */ }

    try {
      let ab;
      if (out?.data?.startsWith("data:")) {
        // base64 data URI
        const b64  = out.data.split(",")[1];
        const bin  = atob(b64);
        const u8   = new Uint8Array(bin.length);
        for (let j=0; j<bin.length; j++) u8[j] = bin.charCodeAt(j);
        ab = u8.buffer;
      } else if (url) {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        ab = await resp.arrayBuffer();
      } else {
        continue;
      }
      bufMap[stemId] = await ctx.decodeAudioData(ab);
    } catch(e) {
      console.warn(`Stem ${stemId} non decodificato:`, e);
    }
  }

  if (!Object.keys(bufMap).length)
    throw new Error("Nessuno stem decodificato. Prova con un file WAV o un brano pi√π corto.");

  pill("p-dec","done");
  setSt("Separazione completata!", "", false, 100);
  await new Promise(r => setTimeout(r, 400));
  return bufMap;
}

// ‚îÄ‚îÄ‚îÄ Build mixer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildMixer(bufMap) {
  stems.forEach(s => {
    const buf = bufMap[s.id] || null;
    s.buffer=buf; s.waveform=buf?makeWave(buf):[]; s.volume=100; s.muted=false; s.solo=false; s.vuLevel=0;
  });
  totalDur = Math.max(...stems.filter(s=>s.buffer).map(s=>s.buffer.duration), 0);
  show("status-card", false);
  show("mixer-card", true); show("ch-card", true); show("ov-card", true);
  $("track-name").textContent = "üéµ " + trackName;
  $("tdur").textContent = "/ " + fmt(totalDur);
  buildChannels(); drawWave(); updateOv();
}

function makeWave(buf) {
  const raw=buf.getChannelData(0), N=500, block=Math.floor(raw.length/N), wv=[];
  for(let i=0;i<N;i++){let s=0;for(let j=0;j<block;j++)s+=Math.abs(raw[i*block+j]);wv.push(s/block);}
  const mx=Math.max(...wv,0.001); return wv.map(v=>v/mx);
}

// ‚îÄ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawWave() {
  const canvas=$("waveform-canvas"), c=canvas.getContext("2d");
  const W=canvas.width, H=canvas.height;
  c.clearRect(0,0,W,H);
  const primary=stems.find(s=>s.waveform.length); if(!primary)return;
  const wv=primary.waveform, bW=2, gap=1, tot=Math.floor(W/(bW+gap));
  const step=Math.floor(wv.length/tot), prog=totalDur>0?curTime/totalDur:0;
  for(let i=0;i<tot;i++){
    const v=wv[i*step]||0, bH=Math.max(2,v*H*.9), x=i*(bW+gap), y=(H-bH)/2;
    c.fillStyle=i/tot<prog?"#5dda9d":"rgba(255,255,255,0.1)";
    c.beginPath(); if(c.roundRect)c.roundRect(x,y,bW,bH,1); else c.rect(x,y,bW,bH); c.fill();
  }
}

$("waveform-wrap").onclick = e => {
  const c=$("waveform-canvas"), r=c.getBoundingClientRect();
  pauseOff=(e.clientX-r.left)/r.width*totalDur;
  curTime=pauseOff; $("tnow").textContent=fmt(curTime); drawWave();
  if(isPlaying){stopAll();startPlay();}
};

// ‚îÄ‚îÄ‚îÄ Playback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stopAll() {
  stemNodes.forEach(n=>{try{n.source.stop();}catch(_){}});
  stemNodes=[]; if(animId)cancelAnimationFrame(animId); if(vuTimer)clearInterval(vuTimer);
  isPlaying=false; stems.forEach(s=>s.vuLevel=0); updateVU();
}

function startPlay() {
  const ctx=getCtx(); if(ctx.state==="suspended")ctx.resume();
  const off=pauseOff; startAt=ctx.currentTime-off;
  stemNodes=stems.filter(s=>s.buffer).map(s=>{
    const src=ctx.createBufferSource(); src.buffer=s.buffer;
    const gn=ctx.createGain(), an=ctx.createAnalyser(); an.fftSize=256;
    gn.gain.value=effGain(s); src.connect(an); an.connect(gn); gn.connect(masterGain);
    src.start(0,off); return{id:s.id,source:src,gainNode:gn,analyser:an};
  });
  isPlaying=true;
  function tick(){
    const el=ctx.currentTime-startAt; curTime=Math.min(el,totalDur);
    $("tnow").textContent=fmt(curTime); drawWave();
    if(el<totalDur){animId=requestAnimationFrame(tick);}
    else{stopAll();pauseOff=0;curTime=0;$("tnow").textContent="0:00";drawWave();updatePlayBtn();}
  }
  animId=requestAnimationFrame(tick);
  const buf=new Uint8Array(128);
  vuTimer=setInterval(()=>{
    stemNodes.forEach(n=>{
      n.analyser.getByteTimeDomainData(buf); let pk=0;
      for(let i=0;i<buf.length;i++){const v=Math.abs(buf[i]-128)/128;if(v>pk)pk=v;}
      const s=stems.find(x=>x.id===n.id); if(s)s.vuLevel=pk*100;
    }); updateVU();
  },55);
  updatePlayBtn();
}

function updateGains() {
  if(!audioCtx)return;
  stemNodes.forEach(n=>{const s=stems.find(x=>x.id===n.id);if(s)n.gainNode.gain.setTargetAtTime(effGain(s),audioCtx.currentTime,.02);});
}
function updatePlayBtn(){ $("btn-play").textContent=isPlaying?"‚è∏":"‚ñ∂"; }
function updateVU(){
  stems.forEach(s=>{
    const lv=effMuted(s)?0:Math.min(100,s.vuLevel);
    const a=$("vu0-"+s.id),b=$("vu1-"+s.id);
    if(a)a.style.height=lv+"%"; if(b)b.style.height=(lv*.88)+"%";
  });
}

// ‚îÄ‚îÄ‚îÄ Channels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildChannels(){
  const wrap=$("ch-wrap"); wrap.innerHTML="";
  stems.forEach(s=>{
    const cfg=STEM_CFGS.find(c=>c.id===s.id); if(!cfg)return;
    const mu=effMuted(s), pct=Math.round(s.volume);
    const db=s.volume===0?"-‚àû":(20*Math.log10(s.volume/100)).toFixed(1);
    const tT=(1-s.volume/150)*100;
    const div=document.createElement("div");
    div.className="ch"; div.id="ch-"+s.id;
    if(s.buffer){div.style.border=`1px solid ${cfg.color}28`;div.style.boxShadow=`0 0 22px ${cfg.glow}`;}
    div.innerHTML=`
      <div class="ch-emoji">${cfg.emoji}</div>
      <div class="ch-name" style="color:${cfg.color}">${cfg.label}</div>
      <div class="vu-wrap">
        <div class="vu-strip"><div class="vu-fill" id="vu0-${s.id}" style="background:linear-gradient(to top,${cfg.color},#fff)"></div></div>
        <div class="vu-strip"><div class="vu-fill" id="vu1-${s.id}" style="background:linear-gradient(to top,${cfg.color},#fff)"></div></div>
      </div>
      <div class="ch-db" id="db-${s.id}">${mu?"MUTE":db+" dB"}</div>
      <div class="fader-track" id="ft-${s.id}">
        <div class="fader-fill" id="ff-${s.id}" style="height:${(s.volume/150)*100}%;background:${mu?"rgba(255,255,255,0.07)":cfg.color};opacity:${mu?.25:.7}"></div>
        <div class="fader-unity" style="top:${(1-100/150)*100}%"></div>
        <div class="fader-thumb" id="fth-${s.id}" style="top:calc(${tT}% - 11px);background:linear-gradient(180deg,${mu?"#2e2e2e":cfg.color+"cc"},${mu?"#1a1a1a":cfg.color+"44"});border-color:${mu?"#3a3a3a":cfg.color};box-shadow:${mu?"none":"0 0 10px "+cfg.glow}"></div>
      </div>
      <div class="ch-pct" id="pct-${s.id}" style="color:${cfg.color}">${pct}%</div>
      <div class="sm-row">
        <button class="btn-sm" id="solo-${s.id}" style="background:${s.solo?cfg.color:"rgba(255,255,255,0.05)"};color:${s.solo?"#000":"#666"};border-color:${s.solo?cfg.color:"rgba(255,255,255,0.1)"}">S</button>
        <button class="btn-sm" id="mute-${s.id}" style="background:${s.muted?"#f97316":"rgba(255,255,255,0.05)"};color:${s.muted?"#fff":"#666"};border-color:${s.muted?"#f97316":"rgba(255,255,255,0.1)"}">M</button>
      </div>
      ${!s.buffer?`<div style="font-size:9px;color:#444;text-align:center;">non disp.</div>`:""}
    `;
    wrap.appendChild(div);
    setupFader(s.id,cfg);
    $("solo-"+s.id).onclick=()=>{s.solo=!s.solo;buildChannels();updateGains();};
    $("mute-"+s.id).onclick=()=>{s.muted=!s.muted;buildChannels();updateGains();};
  });
  $("solo-ban").style.display=hasSolo()?"flex":"none";
  updateOv();
}

function setupFader(id,cfg){
  const track=$("ft-"+id); if(!track)return;
  const s=stems.find(x=>x.id===id);
  const gv=y=>{const r=track.getBoundingClientRect();return Math.max(0,Math.min(150,Math.round((1-(y-r.top)/r.height)*150)));};
  const apply=y=>{s.volume=gv(y);updateFaderUI(id,cfg);updateGains();};
  track.addEventListener("mousedown",e=>{apply(e.clientY);const mv=ev=>apply(ev.clientY),up=()=>{window.removeEventListener("mousemove",mv);window.removeEventListener("mouseup",up);};window.addEventListener("mousemove",mv);window.addEventListener("mouseup",up);e.preventDefault();});
  track.addEventListener("touchstart",e=>{apply(e.touches[0].clientY);const mv=ev=>apply(ev.touches[0].clientY),end=()=>{window.removeEventListener("touchmove",mv);window.removeEventListener("touchend",end);};window.addEventListener("touchmove",mv);window.addEventListener("touchend",end);e.preventDefault();},{passive:false});
}

function updateFaderUI(id,cfg){
  const s=stems.find(x=>x.id===id);if(!cfg)cfg=STEM_CFGS.find(c=>c.id===id);
  const mu=effMuted(s);
  const ff=$("ff-"+id),fth=$("fth-"+id),pct=$("pct-"+id),db=$("db-"+id);
  if(ff){ff.style.height=`${(s.volume/150)*100}%`;ff.style.background=mu?"rgba(255,255,255,0.07)":cfg.color;ff.style.opacity=mu?.25:.7;}
  if(fth){fth.style.top=`calc(${(1-s.volume/150)*100}% - 11px)`;fth.style.background=`linear-gradient(180deg,${mu?"#2e2e2e":cfg.color+"cc"},${mu?"#1a1a1a":cfg.color+"44"})`;fth.style.borderColor=mu?"#3a3a3a":cfg.color;fth.style.boxShadow=mu?"none":`0 0 10px ${cfg.glow}`;}
  if(pct)pct.textContent=Math.round(s.volume)+"%";
  if(db)db.textContent=mu?"MUTE":(s.volume===0?"-‚àû":(20*Math.log10(s.volume/100)).toFixed(1))+" dB";
  updateOv();
}

function updateOv(){
  const wrap=$("ov-rows");wrap.innerHTML="";
  stems.filter(s=>s.buffer).forEach(s=>{
    const cfg=STEM_CFGS.find(c=>c.id===s.id),mu=effMuted(s);
    const d=document.createElement("div");d.className="ov-row";
    d.innerHTML=`
      <span class="ov-name" style="color:${cfg.color}">${cfg.label}</span>
      <div class="ov-track"><div class="ov-bar" style="width:${mu?0:(s.volume/150)*100}%;background:${cfg.color}"></div></div>
      <span class="ov-val">${mu?"mute":Math.round(s.volume)+"%"}</span>
      <div class="badges">
        ${s.solo?`<span class="badge" style="background:${cfg.color}22;color:${cfg.color}">S</span>`:""}
        ${s.muted?`<span class="badge" style="background:rgba(249,115,22,.18);color:#fb923c">M</span>`:""}
      </div>`;
    wrap.appendChild(d);
  });
}

// ‚îÄ‚îÄ‚îÄ Transport events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$("btn-play").onclick  = ()=>{ if(isPlaying){pauseOff=audioCtx.currentTime-startAt;stopAll();}else startPlay(); };
$("btn-stop").onclick  = ()=>{ pauseOff=0;curTime=0;stopAll();$("tnow").textContent="0:00";drawWave();updatePlayBtn(); };
$("btn-reset").onclick = ()=>{ stems.forEach(s=>{s.volume=100;s.muted=false;s.solo=false;});buildChannels();updateGains(); };
$("btn-new").onclick   = ()=>{
  stopAll();pauseOff=0;curTime=0;
  stems.forEach(s=>{s.buffer=null;s.waveform=[];s.volume=100;s.muted=false;s.solo=false;s.vuLevel=0;});
  totalDur=0;trackName="";
  show("mixer-card",false);show("ch-card",false);show("ov-card",false);show("upload-card",true);
  $("file-input").value="";
};
$("clear-solo").onclick = ()=>{ stems.forEach(s=>s.solo=false);buildChannels();updateGains(); };
$("btn-retry").onclick  = ()=>{ show("err-card",false);show("upload-card",true);$("file-input").value=""; };
$("btn-mmut").onclick   = ()=>{ masterMuted=!masterMuted;$("btn-mmut").textContent=masterMuted?"üîá":"üîä";$("btn-mmut").classList.toggle("on",masterMuted);updateGains(); };
$("master-r").oninput   = e=>{ masterVol=+e.target.value;$("master-v").textContent=masterVol+"%";updateGains(); };
$("col-btn").onclick    = ()=>{ transCollapsed=!transCollapsed;$("mixer-body").classList.toggle("collapsed",transCollapsed);$("col-btn").textContent=transCollapsed?"‚ñº":"‚ñ≤"; };

initUI();
</script>
</body>
</html>
