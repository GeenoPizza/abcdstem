<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ABCD Method: Stem ‚Äî Batterista Online</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0d0e;
  --bg2:#111416;
  --surface:rgba(255,255,255,0.05);
  --border:rgba(255,255,255,0.1);
  --border2:rgba(255,255,255,0.15);
  --accent:#5dda9d;
  --accent2:#3a9d7a;
  --accent3:#2a7c5f;
  --text:#e8e8e8;
  --text2:#a0a0a0;
  --text3:#6b6b6b;
  --neutral-400:#a3a3a3;
  --neutral-500:#737373;
  --neutral-600:#525252;
  /* ABCD phase colors */
  --phase-a:#5f8dff;
  --phase-a-text:#98b5f5;
  --phase-b:#f1b54f;
  --phase-b-text:#f4d48a;
  --phase-c:#ff865c;
  --phase-c-text:#ffb08a;
  --phase-d:#5dda9d;
  --phase-d-text:#9de7c6;
}
body{background:var(--bg);color:var(--text);font-family:'DM Sans','Helvetica Neue',sans-serif;min-height:100vh;padding:36px 22px 80px;font-size:16px}
.app{max-width:1040px;margin:0 auto;display:flex;flex-direction:column;gap:18px}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;padding-bottom:18px;border-bottom:1px solid var(--border)}
.logo h1{font-size:2.2rem;font-weight:300;letter-spacing:-.01em;color:#d4d4d8;line-height:1}
.logo h1 .la{font-weight:600;color:#88a7d0}
.logo h1 .lb{font-weight:600;color:#c2b68a}
.logo h1 .lc{font-weight:600;color:#d9a88a}
.logo h1 .ld{font-weight:600;color:#8ab7aa}
.logo h1 .method{padding-left:8px;font-weight:300;color:#a3a3a3}
.logo h1 .stem{color:#8ab7aa;font-weight:600}
.logo-sub{font-size:10px;color:var(--neutral-500);margin-top:6px}
.header-right a{color:var(--neutral-500);text-decoration:none;font-size:11px;transition:color .2s}
.header-right a:hover{color:var(--accent)}

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:22px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.card-label{font-size:9px;text-transform:uppercase;letter-spacing:.4em;color:var(--neutral-500);font-weight:600}

/* ‚îÄ‚îÄ Setup ‚îÄ‚îÄ */
.setup-card{background:rgba(93,218,157,0.03);border:1px solid rgba(93,218,157,0.15);border-radius:20px;padding:24px}
.setup-title{font-size:.95rem;font-weight:600;color:var(--text);margin-bottom:8px}
.setup-desc{font-size:13px;color:var(--neutral-400);line-height:1.75;margin-bottom:18px}
.setup-desc code{background:rgba(255,255,255,0.06);padding:2px 7px;border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;color:var(--text)}
.input-row{display:flex;gap:10px;flex-wrap:wrap}
.space-input{flex:1;min-width:200px;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:12px;padding:11px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;outline:none;transition:border-color .2s}
.space-input:focus{border-color:var(--accent)}
.space-input::placeholder{color:var(--neutral-600)}
.btn-primary{background:linear-gradient(135deg,#3e5c55,#2e4741);border:none;border-radius:12px;padding:11px 20px;color:#fff;font-weight:600;font-size:13px;cursor:pointer;white-space:nowrap;font-family:'DM Sans',sans-serif;box-shadow:0 0 14px rgba(93,218,157,0.15);transition:all .2s}
.btn-primary:hover{box-shadow:0 0 22px rgba(93,218,157,0.3);transform:translateY(-1px)}

/* ‚îÄ‚îÄ Upload ‚îÄ‚îÄ */
.upload-zone{border:2px dashed rgba(93,218,157,0.2);border-radius:16px;padding:48px 24px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;background:rgba(93,218,157,0.02)}
.upload-zone:hover,.upload-zone.over{border-color:rgba(93,218,157,0.45);background:rgba(93,218,157,0.05)}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:2.2rem;margin-bottom:12px}
.upload-title{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:6px}
.upload-sub{font-size:12px;color:var(--neutral-400)}
.upload-fmt{font-size:11px;color:var(--neutral-600);margin-top:6px}
.upload-warn{margin-top:14px;background:rgba(241,181,79,0.06);border:1px solid rgba(241,181,79,0.18);border-radius:12px;padding:12px 16px;font-size:11px;color:#c49a35;line-height:1.7}
.upload-warn b{color:var(--phase-b)}

/* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
.status-inner{display:flex;flex-direction:column;gap:14px}
.status-top{display:flex;align-items:center;gap:14px}
.spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(93,218,157,0.1);border-top-color:var(--accent);animation:spin .8s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.s-title{font-size:.95rem;font-weight:600;color:var(--text)}
.s-sub{font-size:11px;color:var(--neutral-400);margin-top:3px}
.prog-track{height:3px;background:rgba(255,255,255,0.05);border-radius:99px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--accent3),var(--accent));width:0%;transition:width .6s ease;box-shadow:0 0 6px rgba(93,218,157,0.35)}
.prog-fill.slide{width:25%;animation:slide 1.2s ease-in-out infinite}
@keyframes slide{0%{transform:translateX(-350%)}100%{transform:translateX(550%)}}
.steps{display:flex;gap:6px;flex-wrap:wrap}
.pill{font-size:9px;padding:3px 9px;border-radius:99px;border:1px solid rgba(255,255,255,0.08);color:var(--neutral-600);background:rgba(255,255,255,0.02);transition:all .3s;font-weight:500}
.pill.on{border-color:rgba(93,218,157,0.35);color:var(--accent);background:rgba(93,218,157,0.07)}
.pill.done{border-color:rgba(93,218,157,0.15);color:var(--accent2)}
.pill.done::before{content:"‚úì "}

/* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
.err-card{background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.18);border-radius:20px;padding:22px;display:none}
.err-title{font-weight:600;color:#f87171;margin-bottom:6px}
.err-msg{font-size:12px;color:var(--neutral-400);line-height:1.65;white-space:pre-wrap}
.btn-retry{margin-top:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#f87171;border-radius:10px;padding:8px 16px;font-size:12px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s}
.btn-retry:hover{background:rgba(239,68,68,0.2)}

/* ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ */
#waveform-canvas{cursor:pointer}


/* ‚îÄ‚îÄ Transport ‚îÄ‚îÄ */
.transport-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:14px}
#transport-bar{padding:14px 4px 2px;display:flex;flex-direction:column;gap:12px}
#transport-top{display:flex;align-items:baseline;gap:10px}
#transport-top .time-display{font-size:1.8rem}
#track-name{font-size:11px;color:var(--neutral-500);margin-left:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
#transport-btns{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap}
.tbn-ic{width:42px;height:42px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--neutral-400);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.tbn-ic:hover{background:rgba(255,255,255,0.1);color:var(--text)}
.tbn-sep{width:1px;height:28px;background:var(--border);margin:0 2px}
.tbn-txt{height:42px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--neutral-400);cursor:pointer;padding:0 18px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;transition:all .2s;font-family:'DM Sans',sans-serif}
.tbn-txt:hover{background:rgba(255,255,255,0.1);color:var(--text)}
.tbn-grn{height:42px;border-radius:12px;border:1px solid rgba(93,218,157,0.22);background:rgba(93,218,157,0.07);color:var(--accent);cursor:pointer;padding:0 18px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;transition:all .2s;font-family:'DM Sans',sans-serif}
.tbn-grn:hover{background:rgba(93,218,157,0.13)}
.time-display{font-family:'DM Mono',monospace;font-size:1.4rem;font-weight:500;color:var(--accent);min-width:90px}
.time-dur{font-family:'DM Mono',monospace;font-size:11px;color:var(--neutral-600)}
.tbns{margin-left:auto;display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.btn-play-main{width:52px;height:52px;border-radius:14px;border:none;background:linear-gradient(135deg,#3e5c55,#2e4741);color:#fff;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 0 16px rgba(93,218,157,0.18);transition:all .2s}
.btn-play-main:hover{transform:scale(1.06);box-shadow:0 0 24px rgba(93,218,157,0.32)}
.btn-ic{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--neutral-400);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.btn-ic:hover{background:rgba(255,255,255,0.1);color:var(--text)}
.btn-txt{height:36px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--neutral-400);cursor:pointer;padding:0 12px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:5px;transition:all .2s;font-family:'DM Sans',sans-serif;white-space:nowrap}
.btn-txt:hover{background:rgba(255,255,255,0.1);color:var(--text)}
.btn-grn{height:36px;border-radius:10px;border:1px solid rgba(93,218,157,0.2);background:rgba(93,218,157,0.07);color:var(--accent);cursor:pointer;padding:0 12px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:5px;transition:all .2s;font-family:'DM Sans',sans-serif;white-space:nowrap}
.btn-grn:hover{background:rgba(93,218,157,0.13)}
.btn-dl{height:36px;border-radius:10px;border:1px solid rgba(93,218,157,0.3);background:rgba(93,218,157,0.08);color:var(--accent);cursor:pointer;padding:0 14px;font-size:11px;font-weight:700;display:flex;align-items:center;gap:6px;transition:all .2s;font-family:'DM Sans',sans-serif;white-space:nowrap}
.btn-dl:hover{background:rgba(93,218,157,0.15);box-shadow:0 0 12px rgba(93,218,157,0.18)}

/* ‚îÄ‚îÄ Collapse ‚îÄ‚îÄ */
.collapse-btn{width:24px;height:24px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--neutral-400);cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;transition:background .2s}
.collapse-btn:hover{background:rgba(255,255,255,0.1)}
.collapsible{overflow:hidden;transition:max-height .35s ease,opacity .3s ease}
.collapsible.collapsed{max-height:0!important;opacity:0;pointer-events:none}

/* ‚îÄ‚îÄ Solo banner ‚îÄ‚îÄ */
.solo-ban{display:none;align-items:center;gap:7px;font-size:9px;color:#fbbf24;font-weight:700;background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.2);border-radius:8px;padding:4px 10px;letter-spacing:.05em}
.solo-ban button{background:none;border:none;color:#fbbf24;cursor:pointer;opacity:.6;font-size:13px;line-height:1;padding:0}
.solo-ban button:hover{opacity:1}

/* ‚îÄ‚îÄ Channel strip ‚îÄ‚îÄ */
.ch-scroll-outer{overflow-x:auto;margin:-12px;padding:12px;}
.ch-scroll-outer::-webkit-scrollbar{height:2px}
.ch-scroll-outer::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:2px}
#scroll-hint{text-align:center;font-size:10px;color:var(--neutral-600);letter-spacing:.15em;margin-top:10px;user-select:none;transition:opacity .4s}
#scroll-hint.hidden{opacity:0}
.ch-scroll{display:flex;gap:12px;align-items:stretch;padding-bottom:4px;}


.ch{flex-shrink:0;width:120px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,0.03);padding:10px 7px 12px;display:flex;flex-direction:column;align-items:center;gap:7px;position:relative;transition:box-shadow .3s,border-color .3s}

/* LED Display */
.ch-display{width:100%;background:#060809;border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:6px 4px 5px;display:flex;flex-direction:column;align-items:center;gap:3px}
.ch-label-led{font-size:8px;font-weight:700;letter-spacing:.2em;text-transform:uppercase;font-family:'DM Mono',monospace;line-height:1}
.led-meters{display:flex;gap:3px;align-items:flex-end;height:50px;margin-top:2px}
.led-col{display:flex;flex-direction:column;gap:1.5px}
.led-seg{width:9px;height:4.5px;border-radius:1.5px}
.ch-db-led{font-family:'DM Mono',monospace;font-size:7px;color:#2a3035;margin-top:2px;letter-spacing:.05em}

/* Fader */
.fader-track{width:8px;height:175px;border-radius:99px;background:rgba(255,255,255,0.06);position:relative;cursor:pointer;touch-action:none;user-select:none}
.fader-fill{position:absolute;bottom:0;left:0;right:0;border-radius:99px}
.fader-unity{position:absolute;left:-4px;right:-4px;height:1px;background:rgba(255,255,255,0.18);pointer-events:none}
.fader-thumb{position:absolute;left:50%;transform:translateX(-50%);width:26px;height:26px;border-radius:5px;cursor:grab;border:1px solid}
.fader-thumb:active{cursor:grabbing}
.ch-pct{font-size:10px;font-weight:700;font-family:'DM Mono',monospace}
.sm-row{display:flex;gap:4px}
.btn-sm{width:26px;height:22px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--neutral-500);cursor:pointer;font-size:8px;font-weight:700;font-family:'DM Mono',monospace;transition:all .15s;letter-spacing:.05em}
.btn-dl-stem{width:100%;height:20px;border-radius:5px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:var(--neutral-600);cursor:pointer;font-size:8px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:2px;transition:all .2s;font-family:'DM Sans',sans-serif}
.btn-dl-stem:hover{border-color:rgba(93,218,157,0.3);color:var(--accent);background:rgba(93,218,157,0.06)}

/* Master channel */
.ch-master{flex-shrink:0;width:120px;border-radius:16px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.04);padding:10px 7px 12px;display:flex;flex-direction:column;align-items:center;gap:7px}

/* overview removed */

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
footer{border-top:1px solid var(--border);padding-top:28px;text-align:center;margin-top:8px}
footer p{font-size:10px;text-transform:uppercase;letter-spacing:.3em;color:var(--neutral-600);margin-bottom:5px}
.flinks{display:flex;align-items:center;justify-content:center;gap:14px;font-size:10px;margin-bottom:4px}
.flinks a{color:var(--neutral-500);text-decoration:none;transition:color .2s}
.flinks a:hover{color:var(--accent)}
.ver{font-size:10px;color:#2a2a2a;margin-bottom:18px}
.coffee{display:inline-flex;align-items:center;gap:8px;border-radius:99px;border:1px solid var(--border);background:var(--surface);padding:12px 24px;font-size:13px;font-weight:600;color:var(--neutral-400);text-decoration:none;transition:all .2s}
.coffee:hover{border-color:var(--accent);color:var(--accent)}
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="logo">
      <h1><span class="la">A</span><span class="lb">B</span><span class="lc">C</span><span class="ld">D</span><span class="method">method:<span class="stem">stem</span></span></h1>
      <div class="logo-sub">AI Stem Separator ¬∑ batterista.online</div>
    </div>
    <div class="header-right">
      <a href="https://batterista.online" target="_blank">batterista.online</a>
    </div>
  </div>

  <!-- Setup -->
  <div class="setup-card" id="setup-card" style="display:none">
    <div class="setup-title">‚öôÔ∏è Configura il tuo Hugging Face Space</div>
    <div class="setup-desc">Inserisci il tuo Space ID (es. <code>tuonome/abcdstem</code>):</div>
    <div class="input-row">
      <input class="space-input" type="text" id="space-input" placeholder="tuonome/abcdstem"/>
      <button class="btn-primary" id="btn-save-space">Salva ‚Üí</button>
    </div>
  </div>

  <!-- Upload -->
  <div class="card" id="upload-card">
    <div class="card-header">
      <span class="card-label">Carica il brano</span>
      <button class="btn-txt" id="btn-change-space" style="height:24px;font-size:9px;padding:0 8px;display:none">‚öôÔ∏è Space</button>
    </div>
    <div class="upload-zone" id="upload-zone">
      <input type="file" id="file-input" accept=".mp3,.wav,.flac,.ogg,.m4a,audio/*"/>
      <div class="upload-icon">üéµ</div>
      <div class="upload-title">Trascina il tuo brano qui</div>
      <div class="upload-sub">oppure clicca per selezionare il file</div>
      <div class="upload-fmt">MP3 ¬∑ WAV ¬∑ FLAC ¬∑ OGG ¬∑ M4A</div>
    </div>
    <div class="upload-warn">
      ‚è± <b>Attenzione ai tempi:</b> la separazione AI richiede mediamente <b>2‚Äì3 minuti</b>, ma per brani lunghi o complessi possono volerci <b>5 minuti o pi√π</b>. Puoi lasciare la tab in background ‚Äî riceverai una <b>notifica browser</b> quando √® pronto.
    </div>
  </div>

  <!-- Status -->
  <div class="card" id="status-card" style="display:none">
    <div class="status-inner">
      <div class="status-top">
        <div class="spinner"></div>
        <div>
          <div class="s-title" id="s-title">Avvio separazione‚Ä¶</div>
          <div class="s-sub" id="s-sub">Connessione allo Space</div>
        </div>
      </div>
      <div class="prog-track"><div class="prog-fill slide" id="prog"></div></div>
      <div class="steps">
        <div class="pill" id="p-connect">üîå Connessione</div>
        <div class="pill" id="p-upload">üì§ Upload</div>
        <div class="pill" id="p-ai">‚öôÔ∏è Separazione</div>
        <div class="pill" id="p-dec">üîä Decodifica</div>
      </div>
      <div id="s-file" style="font-size:11px;color:var(--neutral-600);margin-top:2px"></div>
    </div>
  </div>

  <!-- Error -->
  <div class="err-card" id="err-card">
    <div class="err-title">‚ö†Ô∏è Errore</div>
    <div class="err-msg" id="err-msg"></div>
    <button class="btn-retry" id="btn-retry">‚Ü© Riprova</button>
  </div>

  <!-- Transport -->
  <div class="card" id="mixer-card" style="display:none">
    <div class="card-header">
      <span class="card-label">Transport</span>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="solo-ban" id="solo-ban">SOLO <button id="clear-solo">‚úï</button></div>
        <button class="collapse-btn" id="col-btn">‚ñ≤</button>
      </div>
    </div>
    <!-- Waveform sempre visibile -->
    <div id="waveform-wrap" style="background:rgba(0,0,0,0.45);border-radius:12px;border:1px solid rgba(255,255,255,0.06);overflow:hidden">
      <canvas id="waveform-canvas" width="920" height="76" style="display:block;width:100%;height:76px;cursor:pointer"></canvas>
    </div>
    <!-- Transport bar: sotto la waveform, centrata -->
    <div class="collapsible" id="mixer-body" style="max-height:240px">
      <div id="transport-bar">
        <!-- Riga 1: tempo + titolo -->
        <div id="transport-top">
          <span class="time-display" id="tnow">0:00</span>
          <span class="time-dur" id="tdur">/ 0:00</span>
          <div id="track-name"></div>
        </div>
        <!-- Riga 2: bottoni centrati -->
        <div id="transport-btns">
          <button class="btn-play-main" id="btn-play">‚ñ∂</button>
          <button class="tbn-ic" id="btn-stop" title="Stop">‚ñ†</button>
          <div class="tbn-sep"></div>
          <button class="tbn-txt" id="btn-reset">‚Ü∫ Reset</button>
          <button class="tbn-grn" id="btn-new">Ôºã Nuovo brano</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Channels -->
  <div class="card" id="ch-card" style="display:none">
    <div class="card-header"><span class="card-label">Stem Channels</span></div>
    <div class="ch-scroll-outer">
      <div class="ch-scroll" id="ch-wrap"></div>
      <!-- Scroll hint -->
      <div id="scroll-hint">‚Äπ scorri ‚Ä∫</div>
    </div>
  </div>

  <footer>
    <p>Copyright ¬© Batterista Online ‚Äî Tutti i diritti riservati</p>
    <div class="flinks">
      <a href="https://batterista.online" target="_blank">www.batterista.online</a>
      <span style="color:var(--neutral-600)">‚Ä¢</span>
      <a href="/cdn-cgi/l/email-protection#98f1f6fef7d8faf9ececfdeaf1ebecf9b6f7f6f4f1f6fd"><span class="__cf_email__" data-cfemail="7a13141c153a181b0e0e1f0813090e1b5415141613141f">[email&#160;protected]</span></a>
    </div>
    <div class="ver">ABCD Method: Stem v1.1</div>
    <a href="https://www.buymeacoffee.com/batterista" target="_blank" class="coffee">
      Aiutami a mantenere questa app gratuita: ‚òï Offrimi un caff√®
    </a>
  </footer>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
'use strict';

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HARDCODED_SPACE_ID = "GeenoPizza/abcdstem";

// ABCD phase colors per gli stem (A=drums,B=bass,C=vocals,D=other)
const STEM_CFGS = [
  { id:"drums",  label:"Drums",  color:"#5f8dff", glow:"rgba(95,141,255,0.28)",  ledOn:"#5f8dff",  ledMid:"#4a73e8",  ledPeak:"#ff4466" },
  { id:"bass",   label:"Bass",   color:"#f1b54f", glow:"rgba(241,181,79,0.28)",  ledOn:"#f1b54f",  ledMid:"#d49a38",  ledPeak:"#ff4466" },
  { id:"vocals", label:"Vocals", color:"#5dda9d", glow:"rgba(93,218,157,0.28)",  ledOn:"#5dda9d",  ledMid:"#3ab87d",  ledPeak:"#ff4466" },
  { id:"other",  label:"Other",  color:"#ff865c", glow:"rgba(255,134,92,0.28)",  ledOn:"#ff865c",  ledMid:"#e06840",  ledPeak:"#ff4466" },
];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let spaceId = HARDCODED_SPACE_ID || localStorage.getItem("hf_space_id") || "";
let stems = STEM_CFGS.map(c=>({id:c.id,volume:100,muted:false,solo:false,buffer:null,waveform:[],vuLevel:0}));
let masterVol=100, masterMuted=false;
let isPlaying=false, curTime=0, totalDur=0, trackName="";
let transCollapsed=false;
let audioCtx=null, masterGain=null;
let stemNodes=[], startAt=0, pauseOff=0, animId=null, vuTimer=null;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt=s=>{if(!s||isNaN(s))return"0:00";return`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,"0")}`};
const hasSolo=()=>stems.some(s=>s.solo);
const effMuted=s=>s.muted||(hasSolo()&&!s.solo);
const effGain=s=>{if(effMuted(s)||masterMuted)return 0;const sv=Math.pow(s.volume/100,2);const mv=Math.pow(masterVol/100,2);return sv*mv;};
const $=id=>document.getElementById(id);
const show=(id,v=true)=>{const e=$(id);if(e)e.style.display=v?"block":"none"};

function getCtx(){
  if(!audioCtx){audioCtx=new(window.AudioContext||window.webkitAudioContext)();masterGain=audioCtx.createGain();masterGain.connect(audioCtx.destination);}
  return audioCtx;
}

// ‚îÄ‚îÄ Space ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initUI(){
  if(spaceId){show("setup-card",false);show("upload-card",true);if(!HARDCODED_SPACE_ID)$("btn-change-space").style.display="flex";}
  else{show("setup-card",true);show("upload-card",false);}
}
$("btn-save-space").onclick=()=>{
  const v=$("space-input").value.trim();
  if(!v.includes("/"))return alert("Formato: tuonome/nome-space");
  spaceId=v;localStorage.setItem("hf_space_id",spaceId);
  show("setup-card",false);show("upload-card",true);$("btn-change-space").style.display="flex";
};
$("space-input").onkeydown=e=>{if(e.key==="Enter")$("btn-save-space").click()};
$("btn-change-space").onclick=()=>{show("upload-card",false);show("setup-card",true);$("space-input").value=spaceId};

// ‚îÄ‚îÄ Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const zone=$("upload-zone"),fi=$("file-input");
zone.addEventListener("dragover",e=>{e.preventDefault();zone.classList.add("over")});
zone.addEventListener("dragleave",()=>zone.classList.remove("over"));
zone.addEventListener("drop",e=>{e.preventDefault();zone.classList.remove("over");const f=e.dataTransfer.files[0];if(f)go(f)});
fi.addEventListener("change",e=>{if(e.target.files[0])go(e.target.files[0])});

// ‚îÄ‚îÄ Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSt(title,sub,slide=false,pct=0){
  $("s-title").textContent=title;$("s-sub").textContent=sub||"";
  const p=$("prog");
  if(slide){p.classList.add("slide");p.style.width="25%";}
  else{p.classList.remove("slide");p.style.width=pct+"%";}
}
function pill(id,state){const e=$(id);if(!e)return;e.classList.remove("on","done");if(state)e.classList.add(state)}

// ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function requestNotifPermission(){
  try{
    if("Notification"in window&&Notification.permission==="default")
      await Notification.requestPermission();
  }catch(_){}
}
async function sendNotif(title,body){
  try{
    if(!("Notification"in window)||Notification.permission!=="granted")return;
    // Su mobile serve ServiceWorker, su desktop funziona new Notification()
    if(navigator.serviceWorker&&navigator.serviceWorker.controller){
      const reg=await navigator.serviceWorker.ready;
      await reg.showNotification(title,{body,icon:"https://batterista.online/favicon.ico"});
    }else{
      new Notification(title,{body,icon:"https://batterista.online/favicon.ico"});
    }
  }catch(_){
    // Silenzioso ‚Äî la notifica non √® critica
  }
}

// ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function go(file){
  trackName=file.name.replace(/\.[^.]+$/,"");
  show("upload-card",false);show("err-card",false);show("status-card",true);
  $("s-file").textContent="üéµ "+file.name;
  setSt("Connessione allo Space‚Ä¶",spaceId,true);
  pill("p-connect","on");pill("p-upload","");pill("p-ai","");pill("p-dec","");
  await requestNotifPermission();
  try{
    const bufs=await separateStems(file);
    sendNotif("ABCD Method: Stem","‚úÖ Pronto! "+trackName+" √® pronto.");
    buildMixer(bufs);
  }catch(err){
    show("status-card",false);show("err-card",true);
    $("err-msg").textContent=err.message||String(err);
  }
}

// ‚îÄ‚îÄ Separation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function separateStems(file){
  const ctx=getCtx();
  const spaceUrl=`https://${spaceId.replace("/","-")}.hf.space`;

  pill("p-connect","done");pill("p-upload","on");
  setSt("Upload del brano‚Ä¶","Invio a Hugging Face",true);

  const formData=new FormData();
  formData.append("files",file);
  let uploadedPath;
  try{
    const r=await fetch(`${spaceUrl}/upload`,{method:"POST",body:formData});
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const json=await r.json();
    uploadedPath=Array.isArray(json)?json[0]:json;
  }catch(e){
    throw new Error(`Impossibile raggiungere lo Space.\n‚Ä¢ Verifica che sia online: huggingface.co/spaces/${spaceId}\n‚Ä¢ Se √® in sleep clicca "Restart" su HF e riprova\n\nDettaglio: ${e.message}`);
  }

  pill("p-upload","done");pill("p-ai","on");
  setSt("Separazione AI in corso‚Ä¶","Demucs sta analizzando il brano‚Ä¶",true);

  const aiStart=Date.now();
  const phases=["Analisi della forma d'onda‚Ä¶","Separazione drums‚Ä¶","Separazione bass‚Ä¶","Separazione vocals‚Ä¶","Separazione other‚Ä¶","Finalizzazione stems‚Ä¶","Ancora un momento‚Ä¶"];
  let phaseIdx=0;
  const timerInterval=setInterval(()=>{
    const el=Math.floor((Date.now()-aiStart)/1000);
    const m=Math.floor(el/60),s=el%60;
    const timeStr=m>0?`${m}m ${s}s`:`${s}s`;
    $("s-sub").textContent=`${phases[phaseIdx%phases.length]} ‚Äî ${timeStr} trascorsi`;
    phaseIdx++;
    const p=$("prog");p.classList.remove("slide");
    p.style.width=Math.min(75,(el/120)*75)+"%";
  },4000);

  let predictData;
  try{
    const r=await fetch(`${spaceUrl}/run/predict`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({fn_index:0,data:[{name:uploadedPath,data:null,is_file:true}],session_hash:Math.random().toString(36).slice(2)})
    });
    clearInterval(timerInterval);
    if(!r.ok)throw new Error(`HTTP ${r.status} ‚Äî ${await r.text().then(t=>t.slice(0,200))}`);
    predictData=await r.json();
  }catch(e){clearInterval(timerInterval);throw new Error(`Errore separazione AI.\n\nDettaglio: ${e.message}`);}

  pill("p-ai","done");pill("p-dec","on");
  setSt("Decodifica audio‚Ä¶","Preparazione dei canali",false,82);

  const outputs=predictData?.data;
  if(!outputs?.length)throw new Error("Il modello non ha restituito audio. Riprova.");

  const stemOrder=["drums","bass","vocals","other"];
  const bufMap={};
  for(let i=0;i<outputs.length;i++){
    const out=outputs[i];
    const stemId=stemOrder[i]||`stem_${i}`;
    setSt(`Decodifica ${stemId}‚Ä¶`,"",false,82+i*4);
    let url=null;
    if(typeof out==="string")url=out;
    else if(out?.url)url=out.url;
    else if(out?.name)url=`${spaceUrl}/file=${out.name}`;
    try{
      let ab;
      if(out?.data?.startsWith("data:")){
        const b64=out.data.split(",")[1],bin=atob(b64),u8=new Uint8Array(bin.length);
        for(let j=0;j<bin.length;j++)u8[j]=bin.charCodeAt(j);ab=u8.buffer;
      }else if(url){
        const resp=await fetch(url);if(!resp.ok)throw new Error(`HTTP ${resp.status}`);ab=await resp.arrayBuffer();
      }else continue;
      bufMap[stemId]=await ctx.decodeAudioData(ab);
    }catch(e){console.warn(`Stem ${stemId}:`,e)}
  }
  if(!Object.keys(bufMap).length)throw new Error("Nessuno stem decodificato. Prova con un file WAV o un brano pi√π corto.");
  pill("p-dec","done");setSt("Separazione completata!","",false,100);
  await new Promise(r=>setTimeout(r,400));
  return bufMap;
}

// ‚îÄ‚îÄ Build mixer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildMixer(bufMap){
  stems.forEach(s=>{const buf=bufMap[s.id]||null;s.buffer=buf;s.waveform=buf?makeWave(buf):[];s.volume=100;s.muted=false;s.solo=false;s.vuLevel=0;});
  totalDur=Math.max(...stems.filter(s=>s.buffer).map(s=>s.buffer.duration),0);
  show("status-card",false);show("mixer-card",true);show("ch-card",true);
  $("track-name").textContent="üéµ "+trackName;
  $("tdur").textContent="/ "+fmt(totalDur);
  buildChannels();drawWave();
}

function makeWave(buf){
  const raw=buf.getChannelData(0),N=500,block=Math.floor(raw.length/N),wv=[];
  for(let i=0;i<N;i++){let s=0;for(let j=0;j<block;j++)s+=Math.abs(raw[i*block+j]);wv.push(s/block);}
  const mx=Math.max(...wv,0.001);return wv.map(v=>v/mx);
}

// ‚îÄ‚îÄ Waveform ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawWave(){
  const canvas=$("waveform-canvas"),c=canvas.getContext("2d");
  const W=canvas.width,H=canvas.height;
  c.clearRect(0,0,W,H);
  const primary=stems.find(s=>s.waveform.length);if(!primary)return;
  const wv=primary.waveform,bW=2,gap=1,tot=Math.floor(W/(bW+gap));
  const step=Math.floor(wv.length/tot),prog=totalDur>0?curTime/totalDur:0;
  for(let i=0;i<tot;i++){
    const v=wv[i*step]||0,bH=Math.max(2,v*H*.88),x=i*(bW+gap),y=(H-bH)/2;
    c.fillStyle=i/tot<prog?"#5dda9d":"rgba(255,255,255,0.09)";
    c.beginPath();if(c.roundRect)c.roundRect(x,y,bW,bH,1);else c.rect(x,y,bW,bH);c.fill();
  }
}
$("waveform-canvas").onclick=e=>{
  const c=$("waveform-canvas"),r=c.getBoundingClientRect();
  pauseOff=(e.clientX-r.left)/r.width*totalDur;curTime=pauseOff;
  $("tnow").textContent=fmt(curTime);drawWave();if(isPlaying){stopAll();startPlay();}
};

// ‚îÄ‚îÄ Playback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stopAll(){
  stemNodes.forEach(n=>{try{n.source.stop()}catch(_){}});
  stemNodes=[];if(animId)cancelAnimationFrame(animId);if(vuTimer)clearInterval(vuTimer);
  isPlaying=false;stems.forEach(s=>s.vuLevel=0);updateVU();updatePlayBtn();
}
function startPlay(){
  const ctx=getCtx();if(ctx.state==="suspended")ctx.resume();
  const off=pauseOff;startAt=ctx.currentTime-off;
  stemNodes=stems.filter(s=>s.buffer).map(s=>{
    const src=ctx.createBufferSource();src.buffer=s.buffer;
    const gn=ctx.createGain(),an=ctx.createAnalyser();an.fftSize=256;
    gn.gain.value=effGain(s);src.connect(an);an.connect(gn);gn.connect(masterGain);
    src.start(0,off);return{id:s.id,source:src,gainNode:gn,analyser:an};
  });
  isPlaying=true;
  function tick(){
    const el=ctx.currentTime-startAt;curTime=Math.min(el,totalDur);
    $("tnow").textContent=fmt(curTime);drawWave();
    if(el<totalDur){animId=requestAnimationFrame(tick);}
    else{stopAll();pauseOff=0;curTime=0;$("tnow").textContent="0:00";drawWave();updatePlayBtn();}
  }
  animId=requestAnimationFrame(tick);
  const buf=new Uint8Array(128);
  vuTimer=setInterval(()=>{
    stemNodes.forEach(n=>{
      n.analyser.getByteTimeDomainData(buf);let pk=0;
      for(let i=0;i<buf.length;i++){const v=Math.abs(buf[i]-128)/128;if(v>pk)pk=v;}
      const s=stems.find(x=>x.id===n.id);if(s)s.vuLevel=pk*100;
    });updateVU();
  },55);
  updatePlayBtn();
}
function updateGains(){
  if(!audioCtx)return;
  stemNodes.forEach(n=>{const s=stems.find(x=>x.id===n.id);if(s)n.gainNode.gain.setTargetAtTime(effGain(s),audioCtx.currentTime,.02);});
}
function updatePlayBtn(){$("btn-play").textContent=isPlaying?"‚è∏":"‚ñ∂"}

// ‚îÄ‚îÄ LED VU meters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LED_ROWS=10;
function updateVU(){
  stems.forEach(s=>{
    const lv=effMuted(s)?0:Math.min(100,s.vuLevel);
    const cfg=STEM_CFGS.find(c=>c.id===s.id);
    const activeLeds=Math.round((lv/100)*LED_ROWS);
    for(let ch=0;ch<2;ch++){
      for(let row=0;row<LED_ROWS;row++){
        const seg=$(`led-${s.id}-${ch}-${row}`);if(!seg)continue;
        const lit=row<activeLeds;
        seg.style.opacity=lit?1:0.06;
        if(lit){
          if(row>=LED_ROWS-2)seg.style.background=cfg.ledPeak;
          else if(row>=LED_ROWS-4)seg.style.background=cfg.ledMid;
          else seg.style.background=cfg.ledOn;
        }
      }
    }
    const dbEl=$("db-led-"+s.id);
    if(dbEl)dbEl.textContent=effMuted(s)?"MUTE":(s.volume===0?"-‚àû":(20*Math.log10(s.volume/100)).toFixed(0))+"dB";
  });
  // Master VU
  const activeStems=stems.filter(s=>s.buffer);
  const masterLv=masterMuted||!activeStems.length?0:Math.min(100,activeStems.reduce((a,s)=>a+s.vuLevel,0)/activeStems.length);
  const mActiveLeds=Math.round((masterLv/100)*LED_ROWS);
  for(let ch=0;ch<2;ch++){
    for(let row=0;row<LED_ROWS;row++){
      const seg=$(`led-master-${ch}-${row}`);if(!seg)continue;
      const lit=row<mActiveLeds;
      seg.style.opacity=lit?1:0.06;
      if(lit)seg.style.background=row>=LED_ROWS-2?"#ff4466":row>=LED_ROWS-4?"#c8c8c8":"#e8e8e8";
    }
  }
}

function makeLedDisplay(id,cfg){
  const color=cfg?cfg.color:"rgba(255,255,255,0.7)";
  const label=cfg?cfg.label:"MASTER";
  let html=`<div class="ch-display">
    <div class="led-meters">`;
  // row 0 = fondo (verde basso), row LED_ROWS-1 = cima (peak rosso)
  // Con flex-direction:column, rendiamo: primo figlio = cima, ultimo = fondo
  // Quindi iteriamo dal row alto al basso (visivamente cima‚Üífondo)
  for(let ch=0;ch<2;ch++){
    html+=`<div class="led-col">`;
    for(let row=LED_ROWS-1;row>=0;row--){
      const c=cfg?(row>=LED_ROWS-2?cfg.ledPeak:row>=LED_ROWS-4?cfg.ledMid:cfg.ledOn):(row>=LED_ROWS-2?"#ff4466":row>=LED_ROWS-4?"#c8c8c8":"#e8e8e8");
      html+=`<div class="led-seg" id="led-${id}-${ch}-${row}" style="background:${c};opacity:0.06"></div>`;
    }
    html+=`</div>`;
  }
  html+=`</div>
    <div class="ch-label-led" style="color:${color}">${label}</div>
    <div class="ch-db-led" id="db-led-${id}">0dB</div>
  </div>`;
  return html;
}

// ‚îÄ‚îÄ Build channels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildChannels(){
  const wrap=$("ch-wrap");wrap.innerHTML="";

  stems.forEach(s=>{
    const cfg=STEM_CFGS.find(c=>c.id===s.id);if(!cfg)return;
    const mu=effMuted(s);
    const tT=(1-s.volume/150)*100;
    const div=document.createElement("div");
    div.className="ch";div.id="ch-"+s.id;
    if(s.buffer){div.style.borderColor=cfg.color+"22";div.style.boxShadow=`0 0 16px ${cfg.glow}`;}
    div.innerHTML=`
      ${makeLedDisplay(s.id,cfg)}
      <div class="fader-track" id="ft-${s.id}">
        <div class="fader-fill" id="ff-${s.id}" style="height:${(s.volume/150)*100}%;background:${mu?"rgba(255,255,255,0.05)":cfg.color};opacity:${mu?.18:.6}"></div>
        <div class="fader-unity" style="top:${(1-100/150)*100}%"></div>
        <div class="fader-thumb" id="fth-${s.id}" style="top:calc(${tT}% - 10px);background:linear-gradient(180deg,${mu?"#1e2326":cfg.color+"aa"},${mu?"#161a1c":cfg.color+"22"});border-color:${mu?"#2a2e32":cfg.color};box-shadow:${mu?"none":"0 0 8px "+cfg.glow}"></div>
      </div>
      <div class="ch-pct" id="pct-${s.id}" style="color:${mu?"var(--neutral-600)":cfg.color}">${Math.round(s.volume)}%</div>
      <div class="sm-row">
        <button class="btn-sm" id="solo-${s.id}" style="background:${s.solo?cfg.color:"var(--surface)"};color:${s.solo?"#000":"var(--neutral-500)"};border-color:${s.solo?cfg.color:"var(--border)"}">S</button>
        <button class="btn-sm" id="mute-${s.id}" style="background:${s.muted?"#f97316":"var(--surface)"};color:${s.muted?"#fff":"var(--neutral-500)"};border-color:${s.muted?"#f97316":"var(--border)"}">M</button>
      </div>
      ${s.buffer?`<button class="btn-dl-stem" id="dl-${s.id}">‚¨á ${cfg.label}</button>`:`<div style="font-size:7px;color:var(--neutral-600);text-align:center">n/a</div>`}
    `;
    wrap.appendChild(div);
    setupFader(s.id,cfg);
    $("solo-"+s.id).onclick=()=>{s.solo=!s.solo;buildChannels();updateGains()};
    $("mute-"+s.id).onclick=()=>{s.muted=!s.muted;buildChannels();updateGains()};
    if(s.buffer)$("dl-"+s.id).onclick=()=>downloadStem(s.id,cfg.label);
  });

  // Master channel
  const mDiv=document.createElement("div");
  mDiv.className="ch-master";mDiv.id="ch-master";
  mDiv.style.boxShadow="0 0 20px rgba(255,255,255,0.07)";mDiv.style.borderColor="rgba(255,255,255,0.18)";
  const mu=masterMuted,tT=(1-masterVol/150)*100;
  mDiv.innerHTML=`
    ${makeLedDisplay("master",null)}
    <div class="fader-track" id="ft-master">
      <div class="fader-fill" id="ff-master" style="height:${(masterVol/150)*100}%;background:${mu?"rgba(255,255,255,0.04)":"rgba(255,255,255,0.55)"};opacity:1"></div>
      <div class="fader-unity" style="top:${(1-100/150)*100}%"></div>
      <div class="fader-thumb" id="fth-master" style="top:calc(${tT}% - 10px);background:linear-gradient(180deg,${mu?"#1e2326":"rgba(255,255,255,0.7)"},${mu?"#161a1c":"rgba(255,255,255,0.2)"});border-color:${mu?"#2a2e32":"rgba(255,255,255,0.6)"};box-shadow:${mu?"none":"0 0 8px rgba(255,255,255,0.2)"}"></div>
    </div>
    <div class="ch-pct" id="pct-master" style="color:${mu?"var(--neutral-600)":"rgba(255,255,255,0.85)"}">${Math.round(masterVol)}%</div>
    <button id="btn-mmut" style="width:54px;height:20px;border-radius:5px;border:1px solid ${mu?"#f97316":"var(--border)"};background:${mu?"rgba(249,115,22,0.18)":"var(--surface)"};color:${mu?"#f97316":"var(--neutral-500)"};cursor:pointer;font-size:8px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:.05em;transition:all .2s">${mu?"MUTE":"MASTER"}</button>
    <button class="btn-dl-stem" id="btn-dl-mix-ch" style="border-color:rgba(255,255,255,0.15);color:rgba(255,255,255,0.6)">‚¨á Mix</button>
  `;
  wrap.appendChild(mDiv);
  setupFader("master",null,true);
  $("btn-mmut").onclick=()=>{masterMuted=!masterMuted;buildChannels();updateGains()};

  $("solo-ban").style.display=hasSolo()?"flex":"none";
}

function setupFader(id,cfg,isMaster=false){
  const track=$("ft-"+id);if(!track)return;
  const gv=y=>{const r=track.getBoundingClientRect();return Math.max(0,Math.min(150,Math.round((1-(y-r.top)/r.height)*150)))};
  const apply=y=>{
    const val=gv(y);
    if(isMaster){masterVol=val;updateMasterFaderUI();}
    else{const s=stems.find(x=>x.id===id);if(s){s.volume=val;updateFaderUI(id,cfg);}}
    updateGains();
  };
  track.addEventListener("mousedown",e=>{apply(e.clientY);const mv=ev=>apply(ev.clientY),up=()=>{window.removeEventListener("mousemove",mv);window.removeEventListener("mouseup",up)};window.addEventListener("mousemove",mv);window.addEventListener("mouseup",up);e.preventDefault()});
  track.addEventListener("touchstart",e=>{apply(e.touches[0].clientY);const mv=ev=>apply(ev.touches[0].clientY),end=()=>{window.removeEventListener("touchmove",mv);window.removeEventListener("touchend",end)};window.addEventListener("touchmove",mv);window.addEventListener("touchend",end);e.preventDefault()},{passive:false});
}

function updateFaderUI(id,cfg){
  const s=stems.find(x=>x.id===id);if(!cfg)cfg=STEM_CFGS.find(c=>c.id===id);
  const mu=effMuted(s),tT=(1-s.volume/150)*100;
  const ff=$("ff-"+id),fth=$("fth-"+id),pct=$("pct-"+id),db=$("db-led-"+id);
  if(ff){ff.style.height=`${(s.volume/150)*100}%`;ff.style.background=mu?"rgba(255,255,255,0.05)":cfg.color;ff.style.opacity=mu?.18:.6;}
  if(fth){fth.style.top=`calc(${tT}% - 10px)`;fth.style.background=`linear-gradient(180deg,${mu?"#1e2326":cfg.color+"aa"},${mu?"#161a1c":cfg.color+"22"})`;fth.style.borderColor=mu?"#2a2e32":cfg.color;fth.style.boxShadow=mu?"none":`0 0 8px ${cfg.glow}`;}
  if(pct){pct.textContent=Math.round(s.volume)+"%";pct.style.color=mu?"var(--neutral-600)":cfg.color;}
  if(db)db.textContent=mu?"MUTE":(s.volume===0?"-‚àû":(20*Math.log10(s.volume/100)).toFixed(0))+"dB";
}

function updateMasterFaderUI(){
  const mu=masterMuted,tT=(1-masterVol/150)*100;
  const ff=$("ff-master"),fth=$("fth-master"),pct=$("pct-master");
  if(ff){ff.style.height=`${(masterVol/150)*100}%`;ff.style.background=mu?"rgba(255,255,255,0.04)":"rgba(255,255,255,0.55)";ff.style.opacity=1;}
  if(fth){fth.style.top=`calc(${tT}% - 10px)`;fth.style.background=`linear-gradient(180deg,${mu?"#1e2326":"rgba(255,255,255,0.7)"},${mu?"#161a1c":"rgba(255,255,255,0.2)"})`;fth.style.borderColor=mu?"#2a2e32":"rgba(255,255,255,0.6)";fth.style.boxShadow=mu?"none":"0 0 8px rgba(255,255,255,0.2)";}
  if(pct){pct.textContent=Math.round(masterVol)+"%";pct.style.color=mu?"var(--neutral-600)":"rgba(255,255,255,0.85)";}
}

function updateOv(){
  const wrap=$("ov-rows");wrap.innerHTML="";
  stems.filter(s=>s.buffer).forEach(s=>{
    const cfg=STEM_CFGS.find(c=>c.id===s.id),mu=effMuted(s);
    const d=document.createElement("div");d.className="ov-row";
    d.innerHTML=`
      <span class="ov-name" style="color:${cfg.color}">${cfg.label}</span>
      <div class="ov-track"><div class="ov-bar" style="width:${mu?0:(s.volume/150)*100}%;background:${cfg.color}"></div></div>
      <span class="ov-val">${mu?"mute":Math.round(s.volume)+"%"}</span>
      <div class="badges">
        ${s.solo?`<span class="badge" style="background:${cfg.color}15;color:${cfg.color}">SOLO</span>`:""}
        ${s.muted?`<span class="badge" style="background:rgba(249,115,22,.14);color:#fb923c">MUTE</span>`:""}
      </div>`;
    wrap.appendChild(d);
  });
}

// ‚îÄ‚îÄ Download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportAudio(buffer, filename){
  // Prova MP3 via MediaRecorder (Chrome/Edge supportano audio/webm;codecs=opus, Safari supporta mp4)
  // Se non disponibile, fallback WAV
  const ctx=getCtx();
  const offCtx=new OfflineAudioContext(buffer.numberOfChannels, buffer.length, buffer.sampleRate);
  const src=offCtx.createBufferSource(); src.buffer=buffer;
  src.connect(offCtx.destination); src.start(0);
  const rendered=await offCtx.startRendering();

  // Tenta export MP3/OGG via MediaRecorder
  const streamCtx=new AudioContext();
  const dest=streamCtx.createMediaStreamDestination();
  const src2=streamCtx.createBufferSource(); src2.buffer=rendered;
  src2.connect(dest); 

  const mimeTypes=["audio/mp4","audio/webm;codecs=opus","audio/ogg;codecs=opus"];
  const mime=mimeTypes.find(m=>MediaRecorder.isTypeSupported(m));

  if(mime){
    const chunks=[];
    const rec=new MediaRecorder(dest.stream,{mimeType:mime,audioBitsPerSecond:192000});
    rec.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data)};
    rec.onstop=()=>{
      streamCtx.close();
      const ext=mime.includes("mp4")?"m4a":mime.includes("ogg")?"ogg":"webm";
      const blob=new Blob(chunks,{type:mime});
      const a=document.createElement("a");a.href=URL.createObjectURL(blob);
      a.download=filename.replace(".wav","."+ext);a.click();URL.revokeObjectURL(a.href);
    };
    src2.start(0);
    rec.start();
    setTimeout(()=>rec.stop(), rendered.duration*1000+200);
  } else {
    // Fallback WAV
    streamCtx.close();
    const wav=bufferToWav(rendered);
    const blob=new Blob([wav],{type:"audio/wav"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=filename;a.click();URL.revokeObjectURL(a.href);
  }
}

async function downloadStem(id,label){
  const s=stems.find(x=>x.id===id);if(!s?.buffer)return;
  await exportAudio(s.buffer,`${trackName}_${label}.wav`);
}

async function downloadMix(){
  const ctx=getCtx();
  const active=stems.filter(s=>s.buffer);if(!active.length)return;
  const len=Math.max(...active.map(s=>s.buffer.length));
  const offCtx=new OfflineAudioContext(2,len,ctx.sampleRate);
  const offMaster=offCtx.createGain();offMaster.connect(offCtx.destination);
  active.forEach(s=>{
    const src=offCtx.createBufferSource();src.buffer=s.buffer;
    const gn=offCtx.createGain();gn.gain.value=effGain(s);
    src.connect(gn);gn.connect(offMaster);src.start(0);
  });
  const rendered=await offCtx.startRendering();
  await exportAudio(rendered,`${trackName}_mix.wav`);
}

function bufferToWav(buffer){
  const nCh=buffer.numberOfChannels,sr=buffer.sampleRate,len=buffer.length;
  const out=new ArrayBuffer(44+len*nCh*2);const v=new DataView(out);
  const w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};
  w(0,"RIFF");v.setUint32(4,36+len*nCh*2,true);w(8,"WAVE");w(12,"fmt ");
  v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,nCh,true);
  v.setUint32(24,sr,true);v.setUint32(28,sr*nCh*2,true);
  v.setUint16(32,nCh*2,true);v.setUint16(34,16,true);w(36,"data");v.setUint32(40,len*nCh*2,true);
  let offset=44;
  for(let i=0;i<len;i++)for(let ch=0;ch<nCh;ch++){
    const s=Math.max(-1,Math.min(1,buffer.getChannelData(ch)[i]));
    v.setInt16(offset,s<0?s*0x8000:s*0x7FFF,true);offset+=2;
  }
  return out;
}

// ‚îÄ‚îÄ Events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$("btn-play").onclick=()=>{if(isPlaying){pauseOff=audioCtx.currentTime-startAt;stopAll();}else startPlay()};
$("btn-stop").onclick=()=>{pauseOff=0;curTime=0;stopAll();$("tnow").textContent="0:00";drawWave();updatePlayBtn()};
$("btn-reset").onclick=()=>{stems.forEach(s=>{s.volume=100;s.muted=false;s.solo=false;});masterVol=100;masterMuted=false;buildChannels();updateGains()};
$("btn-new").onclick=()=>{
  stopAll();pauseOff=0;curTime=0;
  stems.forEach(s=>{s.buffer=null;s.waveform=[];s.volume=100;s.muted=false;s.solo=false;s.vuLevel=0});
  masterVol=100;masterMuted=false;totalDur=0;trackName="";
  show("mixer-card",false);show("ch-card",false);show("upload-card",true);$("file-input").value="";
};
$("clear-solo").onclick=()=>{stems.forEach(s=>s.solo=false);buildChannels();updateGains()};
$("btn-retry").onclick=()=>{show("err-card",false);show("upload-card",true);$("file-input").value=""};
$("col-btn").onclick=()=>{
  transCollapsed=!transCollapsed;
  $("mixer-body").classList.toggle("collapsed",transCollapsed);
  $("col-btn").textContent=transCollapsed?"‚ñº":"‚ñ≤";
};

// ‚îÄ‚îÄ Spacebar play/pause ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener("keydown", e => {
  if(e.code === "Space" && !["INPUT","TEXTAREA"].includes(document.activeElement?.tagName||"")){
    e.preventDefault();
    if(!totalDur) return;
    if(isPlaying){pauseOff=audioCtx.currentTime-startAt;stopAll();}else startPlay();
  }
});

initUI();
// Nascondi scroll hint dopo primo scroll
const outer=document.querySelector('.ch-scroll-outer');
if(outer){outer.addEventListener('scroll',()=>{const h=document.getElementById('scroll-hint');if(h)h.classList.add('hidden');},{once:true});}
</script>
</body>
</html>
